@* Copyright 2012-2013 Fabian Steeg. Licensed under the Eclipse Public License 1.0 *@

@(docs: List[Document], index: String, query: String, category: String, resultFormat: String)

@import helper._
@import tags._
@import controllers.Application.Serialization
@import helper.twitterBootstrap._
@import org.lobid.lodmill.JsonLdConverter.Format
@import play.api.libs.json.Json

@main("Document list") {

    <h1>Welcome to the Lobid API test server</h1>
	<p>Running against index @Document.ES_CLUSTER_NAME on @Document.ES_SERVER.address()</p>
    <h2>Basic API usage</h2>
    <p>The API currently supports queries for lobid resources (by ID and author name), lobid organisations, and GND entries (both by name), e.g.:</p>
    <pre>GET /id/HT002189125 ; GET /author/Abramson ; GET /author/Abramson?index=gnd-index ; GET /search?index=lobid-orgs-index&category=title&query=Escola&format=page</pre>
    <p>See the form below for additional usage samples and optional parameters.</p>

	<h2>Content Negotiation</h2>
	<p>To return different RDF serializations as the result format (default is JSON-LD), you can specify an accept header, e.g. for N-Triples:</p>
	<pre>curl --header "Accept: text/plain" http://api.lobid.org/id/HT002189125</pre>
	<p>Currently supported: @Serialization.values().map((s:Serialization) => s.name + " " + s.getTypes).mkString(", ")</p>

	<h2>Build an API request using a form</h2>
	<p>Use the form below to set up your query parameters (index, category, result format):
	<form action="@routes.Application.config(index, category, resultFormat)" class="form-inline" method="GET">
		<!-- TODO: create a custom tag and extract the common code of these 3 option divs: -->
	    <label class="control-label" for="index">index:</label>
		<!-- We submit on change to update the valid categories for the index: -->
		<select name="index" id="index" onChange="this.form.submit()">
			@for(indexOption <- Document.searchFieldsMap.keySet()){
				<option value="@indexOption" @if(indexOption == index) {selected="selected"} else{}>
					@indexOption
				</option>
			}
		</select>
	    <label class="control-label" for="category">category:</label>
		<select name="category" id="category">
			@for(categoryOption<-Document.searchFieldsMap.get(index).keySet()){
				<option value="@categoryOption" @if(categoryOption == category) {selected="selected"} else{}>
					@categoryOption
				</option>
			}
		</select>
		<label class="control-label" for="format">format:</label>
		<select name="format" id="format">
			@for(formatOption <- controllers.Application.Format.values().map(_.toString.toLowerCase)){
				<option value="@formatOption"  @if(formatOption == resultFormat) {selected="selected"} else{}>
					@formatOption
				</option>
			}
		</select>
		<button type="submit" class="btn">Update</button>
	</form>
	<p>After confirming the parameters above using the 'Update' button, you will get auto-suggestions in the query field below (based on the 'short' result format):</p>
    <form action="@routes.Application.search(index, category, resultFormat, query)" class="form-inline" method="GET">
		<input type='hidden' name='format' value='@resultFormat' />
		<input type='hidden' name='index' value='@index' />
		<input type='hidden' name='category' value='@category' />
	    <label class="control-label" for="query">GET /search with parameters set above and query:</label>
	    <input type="text" name="query" id="query" class="autocomplete"
			data-url="@{routes.Application.autocomplete()}"
			placeholder="query"
			@if(query != "") {value="@query"} />
		<button type="submit" class="btn">Search</button>
	    <script>
	    $('input.autocomplete').each( function() {
	        var $input = $(this);
	        var serverUrl = $input.data('url');
	        $input.autocomplete({ source:serverUrl });
	    });
	    </script>
    </form>

    <h2>@docs.size @if(docs.size == 1) { Document } else { Documents } @if(query!=""){ for '@query' }</h2>
    
    @for(doc <- docs) {
		@defining(doc.getId.split("/").last) { id =>
		<h2><a href="@doc.getId">@doc.getId</a></h2>
		<ul class="nav nav-tabs" id="@id-serializations">
		  <li><a href="#@id-rdfa" data-toggle="tab">RDFa</a></li>
		  <li><a href="#@id-jld" data-toggle="tab">JLD</a></li>
		  <li><a href="#@id-nt" data-toggle="tab">NT</a></li>
		  <li><a href="#@id-n3" data-toggle="tab">N3</a></li>
		  <li><a href="#@id-ttl" data-toggle="tab">TTL</a></li>
		</ul>

		<div class="tab-content">
		  <div class="tab-pane active" id="@id-rdfa">
			@index match {
				case "lobid-index" => {@lobid_resource(Json.parse(doc.getSource))}
				case "gnd-index" => {<pre>@gnd(Json.parse(doc.getSource))</pre>}
				case "lobid-orgs-index" => {<pre>@lobid_organisation(Json.parse(doc.getSource))</pre>}
			}
		  </div>
		  <div class="tab-pane" id="@id-jld"><pre>@doc.getSource</pre></div>
		  <div class="tab-pane" id="@id-nt"><pre>@doc.as(Format.N_TRIPLE)</pre></div>
		  <div class="tab-pane" id="@id-n3"><pre>@doc.as(Format.N3)</pre></div>
		  <div class="tab-pane" id="@id-ttl"><pre>@doc.as(Format.TURTLE)</pre></div>
		</div>

		<script>
		  $(function () {
		    $('#@id-serializations a:first').tab('show');
		  })
		</script>
		}
    }

}
